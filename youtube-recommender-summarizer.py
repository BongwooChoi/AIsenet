import streamlit as st
import google.generativeai as genai
from googleapiclient.discovery import build
from youtube_transcript_api import YouTubeTranscriptApi
import os

# Streamlit ì•± ì„¤ì •
st.set_page_config(page_title="AI YouTube ì¶”ì²œ ë° ìš”ì•½", page_icon="ğŸ¥", layout="wide")

# CSSë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ì •ì˜
st.markdown("""
<style>
.scrollable-container {
    height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
}
</style>
""", unsafe_allow_html=True)

# API í‚¤ ì„¤ì •
genai.configure(api_key=st.secrets["GOOGLE_AI_STUDIO_API_KEY"])
youtube = build('youtube', 'v3', developerKey=st.secrets["YOUTUBE_API_KEY"])

# YouTube ê²€ìƒ‰ í•¨ìˆ˜
def search_videos(query, order='relevance', duration=None, max_results=5):
    request = youtube.search().list(
        q=query,
        type='video',
        part='id,snippet',
        order=order,
        videoDuration=duration,
        maxResults=max_results
    )
    response = request.execute()
    return response['items']

# AI ì¶”ì²œ ì´ìœ  ìƒì„± í•¨ìˆ˜
def get_ai_recommendation(video_title, video_description):
    model = genai.GenerativeModel('gemini-pro')
    prompt = f"ë‹¤ìŒ YouTube ì˜ìƒì— ëŒ€í•œ ì¶”ì²œ ì´ìœ ë¥¼ í•œêµ­ì–´ë¡œ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”:\nì œëª©: {video_title}\nì„¤ëª…: {video_description}"
    response = model.generate_content(prompt)
    return response.text

# ìë§‰ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (YouTube Transcript API ì‚¬ìš©)
def get_video_transcript(video_id):
    try:
        transcript = YouTubeTranscriptApi.get_transcript(video_id, languages=['ko', 'en'])
        return ' '.join([entry['text'] for entry in transcript])
    except Exception as e:
        st.error(f"ìë§‰ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

# ì˜ìƒ ìš”ì•½ í•¨ìˆ˜
def summarize_video(video_id):
    try:
        transcript = get_video_transcript(video_id)
        if not transcript:
            return "ìë§‰ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ìš”ì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

        model = genai.GenerativeModel('gemini-pro')
        prompt = f"ë‹¤ìŒ YouTube ì˜ìƒì˜ ë‚´ìš©ì„ ê°€ë…ì„± ìˆëŠ” í•œ í˜ì´ì§€ì˜ ë³´ê³ ì„œ í˜•íƒœë¡œ ìš”ì•½í•˜ì„¸ìš”. ìµœì¢… ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ ë‚˜ì™€ì•¼ í•©ë‹ˆë‹¤.:\n\n{transcript}"
        response = model.generate_content(prompt)
        summary = response.text

        return summary
    except Exception as e:
        return f"ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

# Streamlit ì•± UI ì½”ë“œ (ì´ì „ê³¼ ë™ì¼)
# ...

# ì£¼ì˜ì‚¬í•­ ë° ì•ˆë‚´
st.sidebar.markdown("---")
st.sidebar.markdown("**ì•ˆë‚´ì‚¬í•­:**")
st.sidebar.markdown("- ì´ ì„œë¹„ìŠ¤ëŠ” Google AI Studio API, YouTube Data API, YouTube Transcript APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
st.sidebar.markdown("- ì˜ìƒì˜ ê¸¸ì´ì™€ ë³µì¡ë„ì— ë”°ë¼ ì²˜ë¦¬ ì‹œê°„ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
st.sidebar.markdown("- ì €ì‘ê¶Œ ë³´í˜¸ë¥¼ ìœ„í•´ ê°œì¸ì ì¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.")
